<%- include("head"); %>
    <%- include("styles_gral"); %>

        <div class="col-md-12" id="lista_archivos" name="lista_archivos">
            <h2>
                <span class="titulo-tabla" style="font-weight: bold;text-align: left;">Lista de Archivos Planos
                </span>
                <span style="float: right;">
                    
                <button type="button" class="btn btn-danger btn-submit"  id="btn-elim-all" name="btn-elim-all" onclick="eliminar_all()" >
                    <i class="fas fa-trash"></i> Eliminar todos.
                    </button>
                </span>
            </h2>



            <% const m=getMessages() %>

                <% if (m.notify) { %>

                    <div class="card" style="margin-top: 20px;" id="card-success">
                        <div class="card-header text-white bg-success mb-3 container-fluid" id="btn-cerrar-ok"><strong>OK!</strong>
                            <button type="button" class="close" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                        </div>

                        <div class="card-body">

                            <% m.notify.forEach((element)=> { %>

                                <%= element %>
                                    <% }) %> %>
                        </div>


                    </div>

                    <% } %>
                        <% if (m.error) { %>

                            <div class="card " style="margin-top: 20px;">
                                <div class="card-header text-white bg-danger mb-3 container-fluid" id="btn-cerrar-err"><strong>Error!</strong>
                                    <button type="button" class="close" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>

                                <div class="card-body">

                                    <% m.error.forEach((element)=> { %>

                                        <%= element %>
                                            <% }) %> %>
                                </div>

                            </div>

                            <% } %>
                                <% if (habilitar_envio_la == true ){ %>
                                    <div class=" form-group" id="div_envio" name="div_envio">
                                        <div class="card">
                                            <div class="card-header text-white bg-success mb-3 container-fluid"><b> ENVIAR</b></div>
                                            <div class="panel-body">
                                                <div style="text-align: center;">
                                                    <button class="btn btn btn-success btn-sm">ENVIAR</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>
                                        <p type="text" id="loading" value="" hidden>loading...</p>
                                        <div class="table-responsive">

                                            <table class="table table-striped table-bordered" style="width:100%" id="tbl_planos">


                                                <thead class="head-tabla-reg">
                                                    <tr>
                                                        <th>Nombre plano</th>
                                                        <th>Nombre IPS</th>
                                                        <th>Periodo cargado</th>
                                                        <th>Fecha de carga</th>
                                                        <th>Validado</th>
                                                        <th>Acciones</th>

                                                    </tr>
                                                </thead>
                                                <tbody id="developers">
                                                    <% for(var i=0; i<arr_files.length; i++) { %>

                                                        <tr>
                                                            <td>
                                                                <%= arr_files[i].nombre_original %>
                                                            </td>
                                                            <td>
                                                                <strong>
                                                            <%= arr_files[i].nombre_ips %>
                                                        </strong>
                                                            </td>
                                                            <td>
                                                                <p><i class="far fa-clock" style="color: cadetblue;"></i>
                                                                    <%= arr_files[i].periodo_cargado %>
                                                                </p>

                                                            </td>

                                                            <td>

                                                                <%= arr_files[i].fecha_carga %>
                                                            </td>
                                                            <td>
                                                                <% if (!arr_files[i].validado) { %>
                                                                    <div>
                                                                        <p><i class="far fa-times-circle" style="color: red;"></i>
                                                                            <%= "No" %>
                                                                        </p>

                                                                    </div>

                                                                    <% } else { %>
                                                                        <p><i class="far fa-check-circle" style="color: green;"></i>
                                                                            <%= "Si" %>
                                                                        </p>

                                                                        <% } %>


                                                            </td>
                                                            <td class="btns-acciones">
                                                                <div class="btn-group">
                                                                    <!--<form method="POST" action="/file/delete/<%= arr_files[i].nombre_tmp %>/archivo-bips/?id_ips=<%= arr_files[i].id_ips %>">-->
                                                                        <% if (!arr_files[i].validado) { %>
                                                                    <form method="post" action="/eliminar-popup/<%= arr_files[i].nombre_original %>/archivo-bips/?id_ips=<%= arr_files[i].id_ips %>&nombre_tmp=<%= arr_files[i].nombre_tmp %>&nombre_ips=<%= arr_files[i].nombre_ips %>">
                                                                        <button class="btn btn-danger btn-submit" value="<%=arr_files[i].nombre_original %>">Eliminar</button>
                                                                    </form>
                                                                    <% }else{ %>
                                                                        <form method="post" action="/eliminar-popup/<%= arr_files[i].nombre_original %>/archivo-bips/?id_ips=<%= arr_files[i].id_ips %>&nombre_tmp=<%= arr_files[i].nombre_tmp %>&nombre_ips=<%= arr_files[i].nombre_ips %>">
                                                                            <button class="btn btn-danger btn-submit" value="<%=arr_files[i].nombre_original %>" disabled>Eliminar</button>
                                                                        </form>

                                                                        <% } %>

                                                                    <form>
                                                                        <% if (!arr_files[i].validado) { %>

                                                                            <input type="button" id="btn-<%= i %>" name="btn-<%= i %>" onclick="validar_plano('<%= arr_files[i].id_ips %>','<%= arr_files[i].nombre_tmp %>')" class="btn btn-success btn-submit" value="Cargar">
                                                                            <% }else{ %>
                                                                                <input type="button" id="btn-<%= i %>" name="btn-<%= i %>" onclick="validar_plano('<%= arr_files[i].id_ips %>','<%= arr_files[i].nombre_tmp %>')" class="btn btn-success btn-submit" value="Cargar" disabled>
                                                                                <% } %>
                                                                    </form>

                                                                </div>





                                                            </td>

                                                        </tr>
                                                        <% }%>
                                                </tbody>
                                                <tfoot>

                                                </tfoot>
                                            </table>

                                        </div>
                                        <div id="planos">

                                        </div>



        </div>

        <style>
            #tbl_planos {
                font-size: 11px;
                font-family: 'Montserrat', sans-serif;
            }
            
            .btns-acciones form .btn-submit {
                font-family: 'Montserrat', sans-serif;
                border-radius: 5px;
                font-size: 12px;
                border: none;
                cursor: pointer;
                transition: .3s ease all;
                font-weight: bold;
            }
            
            #btn-elim-all {
                font-family: 'Montserrat', sans-serif;
                border-radius: 5px;
                font-size: 10px;
                border: none;
                cursor: pointer;
                transition: .3s ease all;
            }
            
            .head-tabla-reg {
                background-color: cadetblue;
                color: #fff;
            }
            
            .titulo-tabla {
                color: cadetblue;
            }
        </style>

        <script type="text/javascript">
            $('.close').click(function() {
                $('#btn-cerrar-ok').parent().fadeOut();
                $('#btn-cerrar-err').parent().fadeOut();
            })

            function eliminar_all() {

                $.ajax({
                    type: 'post',
                    url: "/delete-all/archivo-bips",
                    data: [],
                    contentType: false,
                    cache: false,
                    processData: false,

                    success: function(result) {
                        console.log("Success ... " + result["resultado"]);

                        if (result["resultado"] == "DATA_NOT_FOUND") {
                            alert("No hay planos a eliminar");
                        } else if (result["resultado"] == "OK" && result["status"] == 200) {
                            setTimeout(function() {
                                window.location.reload(1);
                            }, 1000);
                        }

                    }

                });

            }

            function validar_plano(id_ips, nombre_tmp) {

                event.preventDefault();

                $('html, body').animate({
                    scrollTop: 0
                }, 'slow'); //seleccionamos etiquetas,clase o identificador destino, creamos animación hacia top de la página.


                $("#loading").attr("hidden", false);

                const peticion = "/file/validar/" + nombre_tmp + "/archivo-bips/?id_ips=" + id_ips;

                $.ajax({
                    type: 'post',
                    url: peticion,
                    data: [],
                    contentType: false,
                    cache: false,
                    processData: false,

                    beforeSend: function() {

                        $('#loading').html('<div class="text-center"> <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div><strong>&nbsp;&nbsp;Procesando...</strong></div>');
                    },
                    /* error: function () {
                         $('#datos_val').html('<p>Error intente de nuevo...</p>');
                     },*/

                    success: function(result) {


                        console.log(result["habilitar_envio"]);

                        if (result["habilitar_envio"] == true) {
                            alert("se puede enviar la transformacion");
                        }
                        //alert("<div class='alert alert-success' role='alert'>Tiene registros!</div>");
                        //alert("La IPS " + $('#cbxips').val() + " tiene Registros de Archivos Planos para el Rango de Fecha: " + $('#txtfecha_inicial').val() + " hasta " + $('#txtfecha_fin').val());
                        //$('#btn-subir').attr("disabled", true);                                            
                        setTimeout(function() {
                            window.location.reload(1);
                        }, 5000);







                    }
                });
            }

            $(document).ready(function() {

                $('#tbl_planos').DataTable({

                    //Actualizo las etiquetas de mi tabla para mostrarlas en español
                    language: {
                        "sProcessing": "Procesando...",
                        "sLengthMenu": "Mostrar _MENU_ registros",
                        "sZeroRecords": "No se encontraron resultados",
                        "sEmptyTable": "Ningún dato disponible en esta tabla",
                        "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                        "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                        "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                        "sInfoPostFix": "",
                        "sSearch": "Buscar:",
                        "sUrl": "",
                        "sInfoThousands": ",",
                        "sLoadingRecords": "Cargando...",
                        "oPaginate": {
                            "sFirst": "Primero",
                            "sLast": "Último",
                            "sNext": "Siguiente",
                            "sPrevious": "Anterior"
                        },
                        "oAria": {
                            "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                            "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                        },
                    }

                });

                setTimeout(function() {
                    $('#card-success').hide();
                }, 5000);


                $('#card-success').show();
            });
        </script>