<%- include("head"); %>
    <%- include("styles_gral"); %>

        <style>
            body {
                /*background-color: #eaedee;*/
                overflow-x: auto;
                overflow-y: auto;
            }

            body::-webkit-scrollbar {
                display: none;
                overflow-y: hidden;
            }
        </style>

        <body id="body_ent">
            <div class="preview text-center" id="preview"
                style="display: flex;justify-content: center;align-items: center; padding-top: 15px; padding-bottom: 15px;">
                <div class="card col-md-12" id="card-msg">


                </div>
            </div>

            <div class="col-md-12" style="text-align: center; margin-top: 0px;">
                <h2 class="text-center" style="color: #20488f;font-size: 20px">Registro de Indicadores
                </h2>
            </div>

            <div class="tabs-to-dropdown">

                <ul class="nav nav-pills d-none d-md-flex" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <div class="form-group" style="padding-left: 30px;margin: 20px;">
                            <button class="nav-link active btn btn-success" type="button"
                                style="border: 0; padding-top: 0px;height: 20px;" id="btn-nueva-linea"
                                onclick="nuevo_indicador()" data-toggle="pill" href="" role="tab" aria-controls=""
                                aria-selected="true"><i class="fas fa-plus"></i> Indicador</button>

                        </div>
                    </li>
                    <li class="nav-item" role="presentation">
                        <div class="form-group" style="padding-left: 0px;margin: 20px;">

                            <button class="nav-link active btn btn-info" type="button"
                                style="border: 0; padding-top: 0px;height: 20px;" id="btn-nueva-linea" onclick="lista_indicadores()"
                                data-toggle="pill" href="" role="tab" aria-controls="" aria-selected="true"><i
                                    class="fas fa-list"></i> Lista</button>
                        </div>
                    </li>
                </ul>


                <div class="dropdown-divider"></div>

            </div>

            <div
                style="display: flex;justify-content: center;align-items: center;padding-bottom: 0px; margin-top: 0px;">


                <div class="col-md col-md-offset-3" style="padding-bottom: 0px">

                    <div class="card container" id="panel_nuevo_indicador" style=" text-align: center;" hidden>



                        <form id="formulario" enctype="multipart/form-data" method="POST">

                            <div class="form-group row">
                                <label for="txt_onjetivo" class="col-2 col-form-label" style="font-weight: bold;">
                                    Indicador: </label>
                                <div class="col-10">
                                    <textarea class="form-control" type="text" name="txt_indicador"
                                        placeholder="ingresa nombre del indicador" id="txt_indicador"
                                        value=""></textarea>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-2 col-form-label" style="font-weight: bold; ">Plan General: </label>
                                <div class="col-10">
                                    <select class="form-control" name="select_plan" id="select_plan"
                                        data-toggle="tooltip" title="Seleccionar Plan!" data-placement="right" required>
                                        <option selected="selected" value="">Seleccionar Plan General
                                        </option>
                                        <% listaPlanes_grales.forEach(lista=> { %>
                                            <option value="<%= lista.id_plangeneral %>">
                                                <%= lista.plan_general %>
                                            </option>
                                            <% }); %>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-2 col-form-label" style="font-weight: bold;">Linea de acción: </label>
                                <div class="col-10">
                                    <select class="form-control" name="select_linea" id="select_linea"
                                        data-toggle="tooltip" title="Seleccionar Linea de Acción!"
                                        data-placement="right" required>
                                        <option selected="selected" value="">Seleccionar linea de acción
                                        </option>

                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-2 col-form-label" style="font-weight: bold;">Objetivo: </label>
                                <div class="col-10">
                                    <select class="form-control" name="select_objetivo" id="select_objetivo"
                                        data-toggle="tooltip" title="Seleccionar Objetivo!" data-placement="right"
                                        required>
                                        <option selected="selected" value="">Seleccionar Objetivo
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-2 col-form-label" style="font-weight: bold;">Estrategia: </label>
                                <div class="col-10">
                                    <select class="form-control" name="select_estrategia" id="select_estrategia"
                                        data-toggle="tooltip" title="Seleccionar Estrategia!" data-placement="right"
                                        required>
                                        <option selected="selected" value="">Seleccionar Estrategia
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-2 col-form-label" style="font-weight: bold;">Plan de Acción:
                                </label>
                                <div class="col-10">
                                    <select class="form-control" name="select_plan_accion" id="select_plan_accion"
                                        data-toggle="tooltip" title="Seleccionar Plan de Acción!" data-placement="right"
                                        required>
                                        <option selected="selected" value="">Seleccionar plan de Acción
                                        </option>

                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">

                                <label class="col-2 col-form-label" style="font-weight: bold;"
                                    for="select_objetivo">Area: </label>
                                <div class="col-4">
                                    <select class="form-control" name="select_area" id="select_area"
                                        data-toggle="tooltip" title="Seleccionar Objetivo!" data-placement="right"
                                        required>
                                        <option selected="selected" value="">Seleccionar area
                                        </option>
                                        <% lista_areas.forEach(lista=> { %>
                                            <option value="<%= lista.id_area %>">
                                                <%= lista.nombre_area %>
                                            </option>
                                            <% }); %>
                                    </select>

                                </div>

                                <label class="col-2 col-form-label" style="font-weight: bold;">
                                    Tipo Meta:&nbsp; </label>

                                <div class="col-4">
                                    <select class="form-control" name="select_tipo_meta" id="select_tipo_meta"
                                        data-toggle="tooltip" title="Seleccionar Plan de Acción!" data-placement="right"
                                        required>
                                        <option selected="selected" value="">Seleccionar Tipo de meta
                                        </option>
                                        <option value="Descriptiva">Descriptiva</option>
                                        <option value="Numerica">Númerica</option>


                                    </select>
                                </div>
                            </div>
                            
                            <div class="card container" id="panel_descriptiva" style=" text-align: center;" hidden>

                                <div class="form-group row">
                                    <label class="col-2 col-form-label" for="txt_meta_descriptiva" style="font-weight: bold;">
                                        Meta descriptiva: </label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" placeholder="Meta Descriptiva"
                                            name="txt_meta_descriptiva" id="txt_meta_descriptiva" value="">
                                    </div>
    
                                </div>

                                <div class="form-group row">
                                    <label class="col-3 col-form-label" for="txt_fl_descriptiva"
                                        style="font-weight: bold;">Formula Literal Descriptiva : </label>
                                    <div class="col-9">
                                        <input class="form-control" type="text"
                                            placeholder="Formula literal Descriptiva" name="txt_fl_descriptiva"
                                            id="txt_fl_descriptiva" value="">
                                    </div>
    
                                </div>

                            </div>

                            <div class="card container" id="panel_numerica" style=" text-align: center;" hidden>

                                <div class="form-group row">
                                    <label class="col-2 col-form-label" for="txt_meta_numerica" style="font-weight: bold;">
                                        Meta Númerica: </label>
                                    <div class="col-10">
                                        <input class="form-control" type="text" placeholder="Meta numerica"
                                            name="txt_meta_numerica" id="txt_meta_numerica" value="">
                                    </div>
    
                                </div>

                                <div class="form-group row">
                                    <label class="col-3 col-form-label" for="txt_fl_numerador" style="font-weight: bold;">
                                        Formula literal Numerador: </label>
                                    <div class="col-9">
                                        <input class="form-control" type="text" placeholder="numerador"
                                            name="txt_fl_numerador" id="txt_fl_numerador" value="">
                                    </div>
                                </div>
                                
    
                                <div class="form-group row">
                                    <label class="col-3 col-form-label" for="txt_fl_denominador" style="font-weight: bold;">
                                        Formula literal Denominador: </label>
                                    <div class="col-9">
                                        <input class="form-control" type="text" placeholder="Denominador"
                                            name="txt_fl_denominador" id="txt_fl_denominador" value="">
                                    </div>
    
                                </div>
                                </div>                                                

                           

                            <div class="form-group col-sm-12"
                                style="display: flex;justify-content: center;align-items: center;margin-top: 10px;">
                                <div class="text-center">
                                    <button style="font-weight: bold;" class="btn btn-success" id="btn-validar"
                                        name="btn-validar" onclick="almacenar_registro()">Guardar
                                        Indicador</button>
                                </div>
                            </div>

                    </div>

                    </form>

                </div>
            </div>
            </div>

            </div>


            <div class="col-md-12" id="" name="" style="padding-bottom: 30px">

                <iframe src="" title="iframe Vistas control de mando" scrolling="no" onload='' frameBorder="0"
                    class="embed-responsive-item" width="100%" height="600px" name="iframe_indicador" id="iframe_indicador">
                </iframe>
            </div>
        </body>





        <script type="text/javascript">
            function almacenar_registro() {

                event.preventDefault();
                var txt_indicador = $('#txt_indicador').val();
                var plan_accion = $('#select_plan_accion').val();
                var area = $('#select_area').val();
                var tipo_meta = $('#select_tipo_meta').val();
                var formula_descriptiva = $('#txt_fl_descriptiva').val();
                var meta_descriptiva = $('#txt_meta_descriptiva').val();
                var form_literal_numerador = $('#txt_fl_numerador').val();
                var form_literal_denominador = $('#txt_fl_denominador').val();
                var meta_numerica = $('#txt_meta_numerica').val();
                                                                
                        if(meta_numerica == ''){
                              meta_numerica = 0;
                          }

                        var peticion = "/persistir-indicador/"+
                         "?nombre_indicador=" + txt_indicador +
                         "&plan_accion=" + plan_accion+
                         "&area="+area+ 
                         "&tipo_meta=" +tipo_meta+
                         "&formula_descriptiva="+formula_descriptiva+
                         "&meta_descriptiva="+meta_descriptiva+ 
                         "&formula_literal_num="+form_literal_numerador+ 
                         "&form_literal_den=" +form_literal_denominador+
                          "&meta_numerica="+meta_numerica;

                          

                        $.ajax({
                            type: 'post',
                            url: peticion,
                            data: [],
                            contentType: false,
                            cache: false,
                            processData: false,

                            success: function (result) {

                                //history.replaceState("/config-entidades", "Nueva Entidad Bips", "/config-entidades");

                                /*setTimeout(function() {
                                    window.location.reload(1);
                                }, 5000);*/
                                if (result["status"] == 200) {

                                    alert(result["msg"]);

                                    $('#preview').show();

                                    $('#card-msg').html("<div style='' class='card-header text-white bg-success mb-3 container-fluid' id='btn-cerrar'><strong>Operación exitosa!</strong><button type='button' class='close' aria-label='Close'> <span aria-hidden='true'>&times;</span></button></div><div class='card-body-ok' id='card-body-ok'>" + result["msg"] + "</div>");

                                    $('#card-msg').show();

                                    $('#formulario')[0].reset();

                                    //$('#select_linea').focus();
                                   

                                    setTimeout(function () {
                                        $('#preview').hide();
                                    }, 4000);


                                } else {
                                    $('#preview').show();

                                    $('#card-msg').html("<div style='' class='card-header text-white bg-danger mb-3 container-fluid' id='btn-cerrar'><strong>Error!</strong><button type='button' class='close' aria-label='Close'> <span aria-hidden='true'>&times;</span></button></div><div class='card-body-ok' id='card-body-ok'>" + result["msg"] + "</div>");

                                    $('#card-msg').show();

                                    setTimeout(function () {
                                        $('#preview').hide();
                                    }, 5000);

                                    //$('#formulario')[0].reset();

                                    //$('#select_plan').focus();

                                }

                                //$('#body_ent').html(result);


                            }

                        });                   
                
            }



            function nuevo_indicador() {
                //alert("OK");



                $('#panel_nuevo_indicador').attr('hidden', false);
                

                            $('#iframe_indicador').attr("src", '');                            
                            $('#iframe_indicador').attr('hidden', true);

            }

            function lista_indicadores() {
                //alert("OK");
                $('#panel_nuevo_indicador').attr('hidden', true);
                ///lista-ctm-indicadores
                
                            $('#iframe_indicador').attr('hidden', false);
                            $('#iframe_indicador').attr("src", '/lista-ctm-indicadores');
                            $("#iframe_indicador").show();


            }

            $(document).ready(function () {

                $('#preview').hide();
                document.getElementById("select_plan").title = 'Debe elegir un plan general'

                $("#select_plan").change(function () {
                    //$("#btn-subir").prop("disabled", true);
                    //$('#files').attr("disabled", true);
                    // $('#nombre_ips').text($("#cbxips option:selected").text().trim());
                    //$('#nombre_ips').val($("#cbxips option:selected").text().trim());
                    //alert("selecciono la opcion --> " +$("#select_plan option:selected").val());

                    var peticion = "/consultar-lineas-accion_x_plan_general/?id_plan_gral=" + $(this).val();

                    $.ajax({

                        type: 'get',
                        url: peticion,
                        data: [],
                        contentType: false,
                        cache: false,
                        processData: false,

                        success: function (result) {

                            //select_linea
                            $("#select_linea").html("");

                            $("#select_linea").append('<option selected="selected">' + 'Seleccionar linea de acción' + '</option>');

                            result.forEach(element => {

                                //$("#select_linea").append('<option value='+result[0].id_linea+'>'+result[0].linea_accion+'</option>');

                                $("#select_linea").append('<option value=' + element.id_linea + '>' + element.linea_accion + '</option>');

                            });

                        }

                    });


                });

                $("#select_linea").change(function () {
                    //$("#btn-subir").prop("disabled", true);
                    //$('#files').attr("disabled", true);
                    // $('#nombre_ips').text($("#cbxips option:selected").text().trim());
                    //$('#nombre_ips').val($("#cbxips option:selected").text().trim());
                    //alert("selecciono la opcion --> " +$("#select_linea option:selected").val());

                    var peticion = "/consultar-objetivo-x-lineas-accion/?id_linea_accion=" + $(this).val();

                    $.ajax({

                        type: 'get',
                        url: peticion,
                        data: [],
                        contentType: false,
                        cache: false,
                        processData: false,

                        success: function (result) {

                            //select_linea
                            $("#select_objetivo").html("");

                            $("#select_objetivo").append('<option selected="selected">' + 'Seleccionar Objetivo' + '</option>');

                            result.forEach(element => {

                                //$("#select_linea").append('<option value='+result[0].id_linea+'>'+result[0].linea_accion+'</option>');

                                $("#select_objetivo").append('<option value=' + element.id_objetivo + '>' + element.objetivo + '</option>');

                            });

                        }

                    });


                });

                $("#select_objetivo").change(function () {
                    //$("#btn-subir").prop("disabled", true);
                    //$('#files').attr("disabled", true);
                    // $('#nombre_ips').text($("#cbxips option:selected").text().trim());
                    //$('#nombre_ips').val($("#cbxips option:selected").text().trim());
                    //alert("selecciono la opcion --> " +$("#select_linea option:selected").val());

                    var peticion = "/consultar-estrategia-x-objetivo/?id_objetivo=" + $(this).val();

                    $.ajax({

                        type: 'get',
                        url: peticion,
                        data: [],
                        contentType: false,
                        cache: false,
                        processData: false,

                        success: function (result) {

                            //select_linea
                            $("#select_estrategia").html("");

                            $("#select_estrategia").append('<option selected="selected">' + 'Seleccionar Estrategia' + '</option>');

                            result.forEach(element => {

                                //$("#select_linea").append('<option value='+result[0].id_linea+'>'+result[0].linea_accion+'</option>');

                                $("#select_estrategia").append('<option value=' + element.id_estrategia + '>' + element.estrategia + '</option>');

                            });

                        }

                    });


                });

                $("#select_estrategia").change(function () {
                    //$("#btn-subir").prop("disabled", true);
                    //$('#files').attr("disabled", true);
                    // $('#nombre_ips').text($("#cbxips option:selected").text().trim());
                    //$('#nombre_ips').val($("#cbxips option:selected").text().trim());
                    //alert("selecciono la opcion --> " +$("#select_linea option:selected").val());

                    var peticion = "/consultar-plan-accion-x-estrategia/?id_estrategia=" + $(this).val();

                    $.ajax({

                        type: 'get',
                        url: peticion,
                        data: [],
                        contentType: false,
                        cache: false,
                        processData: false,

                        success: function (result) {

                            //select_linea
                            $("#select_plan_accion").html("");

                            $("#select_plan_accion").append('<option selected="selected">' + 'Seleccionar Estrategia' + '</option>');

                            result.forEach(element => {

                                //$("#select_linea").append('<option value='+result[0].id_linea+'>'+result[0].linea_accion+'</option>');

                                $("#select_plan_accion").append('<option value=' + element.id_plan + '>' + element.plan + '</option>');

                            });

                        }

                    });


                });

                $("#select_tipo_meta").change(function () {
                    if($('#select_tipo_meta').val() == "Descriptiva"){
                        $('#panel_numerica').attr('hidden', true);
                        $('#panel_descriptiva').attr('hidden', false);
                    }else{
                        $('#panel_numerica').attr('hidden', false);
                        $('#panel_descriptiva').attr('hidden', true);
                    }
                    
                });


            });





        </script>