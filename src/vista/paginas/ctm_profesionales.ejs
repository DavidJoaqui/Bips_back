<%- include("head"); %>
    <%- include("styles_gral"); %>

        <style>
            body {
                /*background-color: #eaedee;*/
                overflow-x: auto;
                overflow-y: auto;
            }
            
            body::-webkit-scrollbar {
                display: none;
                overflow-y: hidden;
            }
        </style>

        <body id="body_ent" style="margin-top: 0px;">
            <div class="preview text-center" id="preview" style="display: flex;justify-content: center;align-items: center; padding-top: 15px; padding-bottom: 15px;">
                <div class="card col-md-12" id="card-msg">


                </div>
            </div>

            <div class="col-md-12" style="text-align: center;">
                <h2 class="text-center" style="color: #20488f;font-size: 20px">Registro Usuarios.
                </h2>
            </div>

            <div class="tabs-to-dropdown">

                <ul class="nav nav-pills d-none d-md-flex" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <div class="form-group" style="padding-left: 0px;margin: 0px;">

                            <button class="nav-link active btn btn-info" type="button" style="border: 0; padding-top: 0px;height: 20px;" id="btn-nueva-linea" onclick="lista_profesionales()" data-toggle="pill" href="" role="tab" aria-controls="" aria-selected="true"><i class="fas fa-list"></i> Lista Usuarios</button>
                        </div>
                    </li>
                    <li class="nav-item" role="presentation">
                        <div class="form-group" style="padding-left: 0px;margin: 0px;">
                            <button class="nav-link active btn btn-success" type="button" style="border: 0; padding-top: 0px;height: 20px;" id="btn-nuevo-prof" onclick="nuevo_profesional()" data-toggle="pill" href="" role="tab" aria-controls="" aria-selected="true"><i class="fas fa-plus"></i> Usuario</button>
                        </div>
                    </li>
                </ul>




                <div class="dropdown-divider"></div>

            </div>




            <div style="display: flex;justify-content: center;align-items: center;padding-bottom: 0px; margin-top: 0px;">


                <div class="col-md-12 col-md-offset-3" style="padding-bottom: 0px">

                    <div class="container" style=" text-align: center;" id="panel_nuevo_prof" hidden>

                        <div class="card-heading" id="panel_heading">
                            <!--<a href="#" id="btn-cerrar-popup" class="btn-cerrar-popup" onclick="cerrar()"><i class="fas fa-times"></i></a>-->
                            <h3>Nuevo Usuario</h3>
                        </div>

                        <form id="formulario" enctype="multipart/form-data" method="POST" action="">

                            <div class="card container">

                                <div class="form-group row" style="margin-top: 10px;">
                                    <label class="col-2 col-form-label" style="font-weight: bold;">Tipo Identificación:
                                    </label>
                                    <div class="col-4">
                                        <select class="form-control" name="select_tipo_identificacion" id="select_tipo_identificacion" data-toggle="tooltip" title="Seleccionar tipo Identificacion!" data-placement="right" required>
                                            <option selected="selected" value="">Seleccionar Tipo Identificación
                                            </option>
                                            <option value="CC">Cédula de ciudadania</option>
                                            <option value="CE">Cédula de Extranjeria</option>
                                            <option value="PEP">Pasaporte</option>

                                        </select>
                                    </div>
                                    <label class="col-3 col-form-label" for="txt_num_identificacion" style="font-weight: bold;">Número de Identificación: </label>
                                    <div class="col-3">
                                        <input class="form-control" type="text" placeholder="número identificación" name="txt_num_identificacion" id="txt_num_identificacion" value="">
                                    </div>
                                </div>
                                <div class="form-group row">

                                    <label class="col-2 col-form-label" style="font-weight: bold;">
                                        Usuario: </label>
                                    <div class="col-4">
                                        <input class="form-control" type="text" placeholder="ingresar el usuario" name="txt_usuario" id="txt_usuario" value="">
                                    </div>

                                    <label style="font-weight: bold;" class="col-2 col-form-label">Areá Trabajo:</label>

                                    <div class="col-4">
                                        <select class="form-control" name="select_area" id="select_area" data-toggle="tooltip" title="Seleccionar area de Trabajo!" data-placement="right" required>
                                            <option selected="selected" value="">Seleccionar área de Trabajo
                                            </option>
                                            <% lista_areas.forEach(lista=> { %>
                                                <option value="<%= lista.id_area %>">
                                                    <%= lista.nombre_area %>
                                                </option>
                                                <% }); %>
                                        </select>
                                    </div>
                                </div>


                                <div class="form-group row">

                                    <label class="col-2 col-form-label" style="font-weight: bold;">
                                        Contraseña: </label>
                                    <div class="col-4">
                                        <input class="form-control password1" type="password" placeholder="ingresar contraseña" name="txt_password" id="txt_password" value=""><span class="fa fa-fw fa-eye password-icon show-password"></span>
                                    </div>
                                    <label class="col-2 col-form-label" style="font-weight: bold;">
                                        Repita Contraseña: </label>
                                    <div class="col-4">
                                        <input class="form-control password2" type="password" placeholder="ingresar contraseña" name="txt_password2" id="txt_password2" value=""><small id="message"></small>
                                    </div>

                                </div>

                                <div class="form-group row">
                                    <label class="col-2 col-form-label" for="txt_nombre" style="font-weight: bold;">
                                        Nombres: </label>
                                    <div class="col-4">
                                        <input class="form-control" type="text" placeholder="ingresa los nombres" name="txt_nombre" id="txt_nombre" value="">
                                    </div>

                                    <label class="col-2 col-form-label" for="txt_apellido" style="font-weight: bold;">
                                        Apellidos:&nbsp; </label>
                                    <div class="col-4">
                                        <input class="form-control" type="text" placeholder="ingresa los apellidos" name="txt_apellido" id="txt_apellido" value="">
                                    </div>
                                </div>



                                <div class="form-group row">

                                    <label style="font-weight: bold;" class="col-2 col-form-label">Tipo de Rol:</label>

                                    <div class="col-3">
                                        <select class="form-control" name="select_rol" id="select_rol" data-toggle="tooltip" title="Seleccionar rol!" data-placement="right" required>
                                            <option selected="selected" value="">Seleccionar Rol
                                            </option>
                                            <% lista_roles.forEach(lista=> { %>
                                                <option value="<%= lista.id_rol %>">
                                                    <%= lista.nombre_rol %>
                                                </option>
                                                <% }); %>
                                        </select>
                                    </div>

                                    <div class="form-check col-2">
                                        <input class="form-check-input  " type="checkbox" value="" id="is_active" name="is_active" checked>
                                        <label style="font-weight: bold;" class="form-check-label">
                                            Activo</label>
                                    </div>

                                    <div class="form-check col-2">
                                        <input class="form-check-input  " type="checkbox" value="" id="is_profesional" name="is_profesional" checked>
                                        <label style="font-weight: bold;" class="form-check-label">
                                            Profesional</label>
                                    </div>

                                </div>
                                <div class="form-group row">
                                    <label class="col-2 col-form-label" for="txt_nombre" style="font-weight: bold;">
                                        Correo: </label>
                                    <div class="col-5">
                                        <input class="form-control" type="text" placeholder="ingresar correo electronico" name="txt_correo" id="txt_correo" value="">
                                    </div>

                                    <label class="col-2 col-form-label" for="txt_nombre" style="font-weight: bold;">
                                        Telefono: </label>
                                    <div class="col-3">
                                        <input class="form-control" type="text" placeholder="ingresar telefono" name="txt_telefono" id="txt_telefono" value="">
                                    </div>
                                </div>


                                <div class="form-group col-sm-12 text-center" style="display: flex;justify-content: center;align-items: center;margin-top: 10px;">
                                    <button style="font-weight: bold;" class="btn btn-success" id="btn-validar" name="btn-validar" onclick="almacenar_registro()">Guardar</button>
                                    <a href="/ctm-profesionales" class="btn btn-default">volver</a>
                                </div>



                            </div>

                        </form>

                    </div>
                </div>
            </div>



            <div class="col-md-12" id="" name="" style="padding-bottom: 30px">

                <iframe src="/listado-ctm-profesionales" title="iframe Vistas control de mando" scrolling="no" onload='' frameBorder="0" class="embed-responsive-item" width="100%" height="800px" name="iframe_prof" id="iframe_prof">
                </iframe>
            </div>
        </body>





        <script type="text/javascript">
            function almacenar_registro() {

                event.preventDefault();

                var tipo_identificacion = $('#select_tipo_identificacion').val();
                var txt_num_identificacion = $('#txt_num_identificacion').val();
                var txt_nombre = $('#txt_nombre').val();
                var txt_apellido = $('#txt_apellido').val();
                var select_area_trabajo = $('#select_area').val();
                var rol = $('#select_rol').val();
                var correo = $('#txt_correo').val();
                var telefono = $('#txt_telefono').val();
                var nombre_usuario = $('#txt_usuario').val();
                var checkbox_activo = document.getElementById('is_active');
                var activo = true;
                var checkbox_profesional = document.getElementById('is_profesional');
                var profesional = true;

                var password = CryptoJS.MD5($('#txt_password').val());
                //var password_md5  = CryptoJS.MD5($('password');

                //alert(password_md5);
                //console.log(password_md5.toString());



                if (checkbox_activo.checked) {

                    activo = true;
                } else {
                    activo = false;
                }

                if (checkbox_profesional.checked) {

                    profesional = true;
                } else {
                    profesional = false;
                }


                if (txt_num_identificacion != "") {

                    if (txt_nombre != "") {
                        if (select_area_trabajo != "") {


                            var peticion = "/persistir-profesional/?num_identificacion=" + txt_num_identificacion +
                                "&tipo_identificacion=" + tipo_identificacion +
                                "&nombres=" + txt_nombre +
                                "&apellidos=" + txt_apellido +
                                "&area_trabajo=" + select_area_trabajo +
                                "&rol=" + rol +
                                "&correo=" + correo +
                                "&telefono=" + telefono +
                                "&nombre_usuario=" + nombre_usuario +
                                "&profesional=" + profesional +
                                "&activo=" + activo +
                                "&password=" + password;

                            $.ajax({
                                type: 'post',
                                url: peticion,
                                data: [],
                                contentType: false,
                                cache: false,
                                processData: false,

                                success: function(result) {

                                    //history.replaceState("/config-entidades", "Nueva Entidad Bips", "/config-entidades");

                                    /*setTimeout(function() {
                                        window.location.reload(1);
                                    }, 5000);*/
                                    if (result["status"] == 200) {

                                        $('#preview').show();

                                        $('#card-msg').html("<div style='' class='card-header text-white bg-success mb-3 container-fluid' id='btn-cerrar'><strong>Operación exitosa!</strong><button type='button' class='close' aria-label='Close'> <span aria-hidden='true'>&times;</span></button></div><div class='card-body-ok' id='card-body-ok'>" + result["msg"] + "</div>");

                                        $('#card-msg').show();

                                        $('#formulario')[0].reset();

                                        //$('#select_linea').focus();

                                        var iframe = document.getElementById('iframe_prof');

                                        $('#iframe_prof').attr("src", iframe.src);
                                        $("#iframe_prof").show();

                                        setTimeout(function() {
                                            $('#preview').hide();
                                        }, 4000);

                                        $('#panel_nuevo_prof').attr('hidden', true);


                                    } else {
                                        $('#preview').show();

                                        $('#card-msg').html("<div style='' class='card-header text-white bg-danger mb-3 container-fluid' id='btn-cerrar'><strong>Error!</strong><button type='button' class='close' aria-label='Close'> <span aria-hidden='true'>&times;</span></button></div><div class='card-body-ok' id='card-body-ok'>" + result["msg"] + "</div>");

                                        $('#card-msg').show();

                                        setTimeout(function() {
                                            $('#preview').hide();
                                        }, 5000);

                                        //$('#formulario')[0].reset();

                                        //$('#select_plan').focus();

                                    }

                                    //$('#body_ent').html(result);


                                }

                            });

                        } else {
                            $('#select_area').focus();
                        }

                    } else {
                        $('#txt_nombre').focus();
                    }


                } else {
                    //alert("debe escoger una plan gral");
                    $('#txt_identificacion').focus();
                    //$('#txt_objetivo').focus();


                }
            }


            function nuevo_profesional() {
                //alert("OK");
                $('#panel_nuevo_prof').attr('hidden', false);
                $('#iframe_prof').attr("src", '');
                $('#iframe_prof').attr('hidden', true);


            }

            function lista_profesionales() {
                //listado-ctm-objetivos
                $('#panel_nuevo_prof').attr('hidden', true);
                $('#iframe_prof').attr("src", '/listado-ctm-profesionales');
                $('#iframe_prof').attr('hidden', false);

            }


            function cerrar() {
                $('#panel_nuevo_prof').attr('hidden', true);
                //body_ent
                //$('#pills-tab').offset().top;


            }

            $(document).ready(function() {

                $('#preview').hide();


            });



            window.addEventListener("load", function() {

                // icono para mostrar contraseña
                showPassword = document.querySelector('.show-password');
                showPassword.addEventListener('click', () => {

                    // elementos input de tipo clave
                    password1 = document.querySelector('.password1');
                    password2 = document.querySelector('.password2');

                    if (password1.type === "text") {
                        password1.type = "password"
                        password2.type = "password"
                        showPassword.classList.remove('fa-eye-slash');
                    } else {
                        password1.type = "text"
                        password2.type = "text"
                        showPassword.classList.toggle("fa-eye-slash");
                    }

                })
            });



            $('#txt_password, #txt_password2').on('keyup', function() {
                if ($('#txt_password').val() == $('#txt_password2').val()) {
                    $('#message').html('').css('color', 'green');
                } else
                    $('#message').html('Contraseñas no coinciden').css('color', 'red');
            });
        </script>
        <style>
            .password-icon {
                float: right;
                position: relative;
                margin: -25px 10px 0 0;
                cursor: pointer;
            }
        </style>